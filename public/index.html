<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Translatify</title>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
</head>
<body>
  <div class="col-xs-10 col-xs-offset-1 col-sm-6 col-sm-offset-3" style="margin-top: 40px; font-size: 30px;">
    <div class="translatify">你好，我是布莱恩。你叫什么名字？</div>
    <table id="word-table" class="table table-condensed table-hover" style="font-size: 15px;">
      <thead>
        <th>Word</th>
        <th>Pronunciation</th>
        <th>Translation</th>
      </thead>
      <tbody id="word-list"></tbody>
    </table>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="translatify.js"></script>
  <script src="dictionary.js"></script>
  <script>
    translatify([dictionary]);

    var $wordTable = $('#word-table');
    var $wordList = $('#word-list');


    function styleWord(word) {
      return $('<tr><td>' + word.text + '</td><td>' + 
        word.pronunciation + '</td><td>' +
        word.translation + '</td></tr>');
    }

    function formatText(text) {
      var word = {
        text: text,
        pronunciation: dictionary[text].pronunciation,
        translation: dictionary[text].translation
      };
      return word;
    }

    function addWord(text) {
      var word = formatText(text);

      $.post('/api/user/' + state.userId + '/words', {word: text})
      .done(function() {
        $wordTable.show();
        $wordList.append(styleWord(word));
      })
      .fail(function(err) {
        console.log(err);
      })
    }

    function init() {
      var state = {
        userId: null
      };

      $('.translatify > span').on('click', function() {
        addWord($(this).text());
      });

      $.get('/api/user')
      .done(function(users) {
        if (users.length > 0) {
          state.userId = users[0]._id;
          $.get('/api/user/' + state.userId + '/words')
          .done(function(words) {
            console.log('appending words from server');
            if (words.length > 0) {
              $wordTable.show();
              words.forEach(function(word) {
                $wordList.append(styleWord(formatText(word)));
              });
            }
          })
          .fail(function(err) {
            console.log(err);
          });
        }
      })
      .fail(function(err) {
        console.log(err);
      });

      $wordTable.hide();
      return state;
    }

    var state = init();
  </script>
</body>
</html>
